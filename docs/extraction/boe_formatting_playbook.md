# BOE Formatting Playbook
# قواعد تنسيق استخراج الأنظمة من هيئة الخبراء

> مستخلص من استخراج ~30 نظام تجريبي من boe.gov.sa.
> يُستخدم كمرجع إلزامي لأي استخراج قادم.

---

## A) قواعد صارمة (No Hallucination)

1. **ممنوع توليد أي نص غير موجود** في المصدر الأصلي.
2. **حفظ `raw_text` كما هو** دائمًا بدون أي تعديل — هذا هو السجل القانوني.
3. توليد **`normalized_for_display`** (للعرض فقط) بدون تغيير كلمات — فقط أسطر/مسافات/تبويب/علامات ترقيم تنسيقية.
4. أي تعذّر تحميل أو نقص محتوى:
   - وسم واضح (`load_failed` / `partial_content`)
   - إعادة محاولة (3 مرات مع تأخير تصاعدي)
   - fallback موثق (DOM snapshot أو HTML خام)
   - تسجيل في log مع timestamp + URL + HTTP status

---

## B) Normalization للعرض فقط (لا تغيّر كلمات)

| القاعدة | قبل | بعد | ملاحظة |
|---------|------|------|--------|
| توحيد أسطر | `\r\n` | `\n` | Windows → Unix |
| تقليل أسطر فارغة | `\n\n\n+` | `\n\n` | 3+ أسطر → 2 |
| إزالة Tabs | `\t` | ` ` (مسافة) | لمنع الفراغات الضخمة داخل التعداد |
| توحيد حروف sub-items | `أ :` / `أ -` | `أ :` | توحيد الفاصل بعد حرف التعداد (وكذلك ب/ج/د...) |

### دمج `NUM_ONLY` مع السطر التالي

إذا سطر يحتوي رقم فقط بدون نص، والسطر التالي نص عادي → ادمجهما:

```
قبل:
7-
تحقيق التنسيق ...

بعد:
7- تحقيق التنسيق ...
```

**استثناء**: إذا كان السطر التالي يبدأ بحرف تعداد (`أ:` / `ب:`) → **لا تدمج** لأن الرقم parent وله sub-items.

### معالجة الاقتباسات في نصوص التعديلات/الإضافات

- إزالة `"` الملتصقة ببداية رقم التعداد أو بنهاية آخر عنصر تعداد (للعرض فقط).
- لا تغيّر النص الفعلي — فقط تجريد علامات الاقتباس التنسيقية من حدود التعداد.

---

## C) Parsing (حوّل النص إلى AST قائمة قبل العرض)

### State Machine إلزامي

```
currentNum = null   // آخر بند رقمي مفتوح (parent)
```

### Regex أساسية

```regex
NUM_ONLY:   ^\s*([0-9٠-٩]+)\s*[-–.)]\s*$
NUM_TEXT:   ^\s*([0-9٠-٩]+)\s*[-–.)]\s*(.+)$
LETTER:     ^\s*([أ-ي])\s*[:：-–]\s*(.+)$
```

### قواعد Parsing

| الحالة | الإجراء |
|--------|---------|
| `NUM_ONLY` | افتح parent جديد (نصه فارغ)، اجعل `currentNum = parent` |
| `NUM_TEXT` | افتح parent جديد بنصه، اجعل `currentNum = parent` |
| `LETTER` مع وجود `currentNum` | أنشئ **child item مستقل** تحت parent — لا يُعامل كـ continuation داخل نفس الفقرة |
| سطر غير مطابق + آخر عنصر كان child | ألحقه بنص child كتكملة |
| سطر غير مطابق + آخر عنصر كان parent | ألحقه بنص parent كتكملة |

### الحالة الحرجة: API يرجّع marker رقمي مع text يبدأ بحرف

حتى لو الـ API رجّع:
```json
{ "marker": "6-", "text": "أ : توفير البيانات..." }
```

**لا تعتمد على شرط `marker == ""`**.

أضف قاعدة إضافية بعد استخراج الـ marker:

```
إذا marker رقمي AND text يبدأ بـ LETTER_PATTERN:
  → Split إلى:
    Parent: marker="6-", text=""
    Child:  marker="أ :", text="توفير البيانات..."
```

ثم اربط أي `ب :` لاحق كـ child مستقل تحت نفس الـ parent الرقمي.

### ربط حروف التعداد المستقلة (Letter Linking)

إذا marker حرف (`أ`/`ب`/`ج`...) بدون parent رقمي سابق → أبقه كعنصر مستقل.
إذا marker حرف وموجود parent رقمي سابق بنفس المستوى أو أعلى → اجعل `dataLevel = lastNumericLevel + 1`.

### تطبيع المستويات (Level Normalization)

بعد حساب كل المستويات، اطرح `minLevel` من جميع العناصر التي لها marker:
```
visualLevel = dataLevel - minLevel
```
هذا يضمن أن أول مستوى يبدأ من 0 (بدون indent) حتى لو الـ API أعطى مستويات تبدأ من 1 أو 2.

---

## D) Rendering ثابت ومحاذاة صحيحة RTL

### Layout: Grid وليس Flex

```css
display: grid;
grid-template-columns: auto 1fr;
column-gap: 8px;
```

- عمود الـ marker: `shrink-0`, `whitespace-nowrap`, `font-bold`
- عمود النص: `min-w-0` + `overflow-wrap: anywhere` + `word-break: break-word`

### ممنوع على النص القانوني الكامل

- `truncate`
- `line-clamp`
- `whitespace-nowrap`
- `overflow: hidden` (على حاوية النص)

### Indent المستويات

تراكمي بناءً على `visualLevel`:

| Level | `paddingInlineStart` |
|-------|---------------------|
| 0 | `0px` |
| 1 | `30px` |
| 2 | `60px` |

استخدم `paddingInlineStart` (وليس `marginRight`) لضمان عمل RTL بشكل صحيح.

### محاذاة فقرات الاستمرار (Continuation Paragraphs)

فقرة بدون marker بعد عنصر مرقّم → أعطها indent يحاكي محاذاة النص (marker width + gap):

| Level سابق | `paddingInlineStart` للاستمرار |
|------------|-------------------------------|
| 0 | `28px` |
| 1 | `58px` |
| 2+ | `88px` |

---

## E) حالات عامة لازم تغطيها المنصة

### 1. "النظام غير موجود" رغم ظهوره في المكتبة
- لا تعتمد الإدخال إلا بعد فتح صفحة التفاصيل والتحقق من وجود (العنوان + جسم المحتوى).
- إذا 404 أو غير موجود → وسم `broken_link` + log + retry.

### 2. مواد معدّلة/ملغاة
- وسم الحالة (`amended` / `repealed`).
- عرض تنبيه واضح دون دمج يضيّع النص الأصلي.

### 3. المرفقات/الصور/PDF
- لا OCR عشوائي.
- اربط الأصل كملحق واحتفظ به كما هو.

### 4. محتوى ديناميكي (show more / lazy load)
- استخراج JS-enabled مع scroll/click.
- Fallback: DOM snapshot كاملة.

### 5. مواد فارغة أو مجزأة
- وسم `suspected_empty` أو `suspected_fragment`.
- Retry + حفظ snapshot HTML للمراجعة اليدوية.

### 6. فقرات تبدأ بشرطة (`- نص`)
- هذه عناصر قائمة مستقلة وليست continuation للفقرة السابقة.
- **ممنوع دمجها** مع الفقرة التي قبلها حتى لو الفقرة السابقة لها marker.

---

## F) Checklist قبل أي merge (مختصر)

- [ ] `raw_text` محفوظ بدون تعديل؟
- [ ] Normalization للعرض فقط (لا كلمات تغيّرت)؟
- [ ] `LETTER:` (أ/ب/ج...) تظهر كسطر sub-item مستقل؟
- [ ] `NUM_ONLY` يندمج مع نصه عند اللزوم (ما لم يتبعه letter sub-item)؟
- [ ] لا `truncate` / `nowrap` على النص القانوني؟
- [ ] RTL ومحاذاة marker/text ثابتة (Grid)؟
- [ ] Level normalization مطبّق (أول مستوى = 0)؟
- [ ] فقرات الاستمرار لها indent صحيح؟
- [ ] إحالات المواد (المادة الخامسة) تُكتشف وتُعرض كروابط؟
- [ ] إحالات متعددة (المادتين الرابعة والسادسة) كلها قابلة للنقر؟

---

## G) Verified Issues We Already Hit

### 1. فجوة كبيرة بين الرقم والنص في المستوى الأول
- **Symptom**: مسافة واسعة بين marker (مثل `1-`) والنص في أول مستوى تعداد.
- **Cause**: استخدام `flex` مع `gap-3` + المستوى الأول كان يحصل على `marginRight: 30px` بدلاً من 0.
- **Fix**: تحويل من Flex إلى CSS Grid (`grid-template-columns: auto 1fr`, `columnGap: 8`) + Level Normalization (طرح `minLevel` من كل المستويات).
- **Test**: فتح أي نظام به تعداد رقمي — التحقق أن المستوى الأول بدون indent والمسافة بين الرقم والنص معقولة.

### 2. حرف التعداد (أ/ب) ملتصق بالبند الرقمي بدلاً من سطر مستقل
- **Symptom**: `6- أ : توفير البيانات...` تظهر كسطر واحد بدلاً من parent `6-` وتحته child `أ :`.
- **Cause**: الـ API يرجّع `marker="6-"` و `text="أ : توفير..."`. الكود كان يبحث عن compound pattern فقط عندما `marker==""` فلم يطابق.
- **Fix**: إضافة فحص مستقل بعد كل معالجة marker: إذا marker رقمي و text يبدأ بـ `^([أ-ي])\s*[-–:]\s*` → split إلى parent (text فارغ) + child (بالنص).
- **Test**: فتح نظام المركز الوطني للوثائق، المادة الثالثة — البنود 6 و 8 يجب أن تظهر فيها أ/ب كعناصر فرعية مستقلة.

### 3. حروف تعداد مستقلة (ب:) لا تُربط كأبناء تحت البند الرقمي
- **Symptom**: `ب : تجميع الأنظمة...` تظهر بنفس مستوى indent البند الرقمي `6-` بدلاً من مستوى أعمق.
- **Cause**: الـ API يرجّع `marker=""` و `text="ب : تجميع..."`. لم يكن هناك استخراج للحرف من النص ولا ربطه بالـ parent.
- **Fix**: (1) استخراج الحرف من بداية النص عندما `marker==""` باستخدام regex `^([أ-ي])\s*[-–:]\s*`. (2) Letter Linking: بعد كل المعالجة، إذا letter marker بنفس مستوى أو أقل من آخر numeric parent → رفع `dataLevel` إلى `lastNumericLevel + 1`.
- **Test**: نفس المادة أعلاه — `ب :` يجب أن تظهر تحت `6-` بـ indent 30px.

### 4. فقرات تبدأ بشرطة تُدمج مع الفقرة السابقة
- **Symptom**: `- رقم الإيداع` تظهر ملتصقة بنهاية سطر `ج- تضمين العمل.` بدلاً من سطر جديد.
- **Cause**: كود merge split paragraphs كان يدمج أي فقرة تبدأ بـ `"- "` مع الفقرة السابقة إذا كانت لها marker (`isDashContinuation`).
- **Fix**: إزالة شرط `isDashContinuation` بالكامل. الفقرات التي تبدأ بشرطة هي عناصر قائمة مستقلة.
- **Test**: فتح النظام الذي يحتوي على بنود `ج-` متبوعة بعناصر شرطة — كل عنصر يجب أن يظهر في سطر مستقل.

### 5. إحالات المواد المتعددة لا تُكتشف كلها
- **Symptom**: في "والمادتين الرابعة والسادسة" فقط "الرابعة" تظهر كرابط، "والسادسة" تبقى نص عادي.
- **Cause**: بعد اكتشاف أول إحالة (الرابعة)، لم يكن هناك منطق للبحث عن إحالات متتابعة بصيغة "و + ordinal".
- **Fix**: إضافة continuation loop بعد اكتشاف إحالة بدون أقواس لـ trigger جمعي (المادتين/المادتان/المواد): يبحث عن `^\s*و\s*` + ordinal ويضيفها كإحالة.
- **Test**: فتح مادة تحتوي "والمادتين الرابعة والسادسة" — كلا الرقمين يجب أن يكونا روابط قابلة للنقر.

### 6. كلمة "المواد" تُكتشف كـ trigger إحالة خطأ
- **Symptom**: في "المواد المذكورة في المادة الثانية"، كلمة "المواد" تُعامل كـ trigger وتأخذ "المذكورة في المادة الثانية" كإحالة خاطئة.
- **Cause**: `parseArabicArticleNumber` يستخدم `.includes()` فيجد "الثانية" داخل نص طويل ويعيد 2. و `extractNumberText` يعيد كل النص حتى "الثانية".
- **Fix**: إضافة شرط: أول كلمة بعد trigger يجب أن تكون رقم/ترتيب عربي (`parseArabicArticleNumber(firstWord) !== null`)، وإلا لا تُعتبر إحالة.
- **Test**: فتح مادة تحتوي "المواد المذكورة في المادة الثانية" — "المواد" لا تُنشئ رابط خاطئ، و"المادة الثانية" تظهر كرابط صحيح.

### 7. تجاوز النص (Text Overflow) في حاوية المحتوى
- **Symptom**: نص طويل بدون مسافات (أو كلمات طويلة) يتجاوز حدود الحاوية أفقياً.
- **Cause**: غياب `overflow-wrap` و `word-break` على حاوية النص.
- **Fix**: إضافة `overflow-wrap: anywhere` + `word-break: break-word` + `min-w-0` على عمود النص في Grid.
- **Test**: فحص بصري لمواد بنصوص طويلة — لا يجب أن يظهر scroll أفقي.

### 8. Vite HMR لا يعكس التغييرات
- **Symptom**: تعديل الكود لا يظهر في المتصفح حتى بعد حفظ الملف.
- **Cause**: Vite cache قديم في `node_modules/.vite`.
- **Fix**: حذف `node_modules/.vite` + إعادة تشغيل السيرفر + Hard Refresh في المتصفح (Ctrl+Shift+R).
- **Test**: تعديل أي ملف → التحقق أن التغيير يظهر فوراً.

---

## H) Candidate Issues (Needs Validation)

### 1. المادة رقم (X) — إحالة بـ "رقم" بين trigger والقوس
- **Symptom**: "المادة رقم (5)" قد لا تُكتشف كإحالة.
- **Hypothesis**: الـ parenMatch يبحث عن `(` مباشرة بعد trigger. كلمة "رقم" بينهما تمنع المطابقة. والـ nonParenMatch سيفشل لأن "رقم" ليست ordinal.
- **How to validate**: البحث في قاعدة البيانات عن نصوص تحتوي "المادة رقم (" والتحقق إذا تُكتشف كإحالة.

### 2. أرقام هندية (٠-٩) في markers
- **Symptom**: بند مرقّم بأرقام هندية (مثل `٦-`) قد لا يُعالج بشكل صحيح في بعض المسارات.
- **Hypothesis**: بعض regex patterns تستخدم `\d` فقط (أرقام غربية) بدون `[٠-٩]`.
- **How to validate**: البحث عن أنظمة تستخدم أرقام هندية في الـ markers والتحقق من العرض.

### 3. مواد مركّبة: "الحادية والعشرين" وما فوق
- **Symptom**: إحالة لمادة رقم 21+ قد لا تُكتشف بشكل صحيح.
- **Hypothesis**: `extractNumberText` قد يأخذ "الحادية" فقط (= 1) بدلاً من "الحادية والعشرين" (= 21) إذا كانت "الحادية" exact match في القاموس.
- **How to validate**: اختبار نص يحتوي "المادة الحادية والعشرين" والتحقق أن الرابط يشير للمادة 21 وليس 1.

### 4. إحالات بين أنظمة مختلفة
- **Symptom**: "المادة الخامسة من نظام العمل" — الإحالة تشير لمادة في النظام الحالي بدلاً من نظام آخر.
- **Hypothesis**: الكود يبحث فقط في مواد النظام الحالي ولا يتعامل مع إحالات بين أنظمة.
- **How to validate**: البحث عن نصوص تحتوي "من نظام" بعد إحالة مادة.

---

## I) Template لتسجيل مشكلات مستقبلية

```markdown
### [رقم]. [عنوان مختصر]
- **Symptom**: [وصف ما يظهر للمستخدم]
- **Input example (raw)**: [النص الخام من API/DB]
- **Normalized example**: [النص بعد المعالجة]
- **Expected UI**: [كيف يجب أن يظهر]
- **Root cause**: [السبب التقني]
- **Fix**: [التعديل المطلوب]
- **Regression test**: [كيف تتحقق أن المشكلة لم تعد]
```

---

> آخر تحديث: 2026-02-10
> الملفات المرتبطة:
> - `client/src/pages/LawDetail.tsx` (parser + renderer رئيسي)
> - `client/src/components/ArticleReferenceText.tsx` (parser إحالات + renderer مرجع)
> - `client/src/components/NumberedItem.tsx` (مكوّن العرض Grid)
