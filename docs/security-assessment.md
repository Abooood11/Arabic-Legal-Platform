# تقييم أمني سريع للمنصة

تاريخ المراجعة: 2026-02-14  
نطاق المراجعة: مراجعة كود (Static Review) لمسارات API والواجهات المرتبطة بها.

## ملخص تنفيذي

تم العثور على 4 نقاط ضعف رئيسية:

1. **تجاوز كامل للمصادقة والتفويض** على مسارات الإدارة (حرج).
2. **ثغرة XSS مخزنة/منعكسة محتملة** عبر `dangerouslySetInnerHTML` دون تعقيم قوي (مرتفع).
3. **قابلية DoS** بسبب غياب حد أعلى لقيمة `limit` في بحث الأحكام (متوسط).
4. **مخاطر إساءة الاستخدام/Spam** في نقطة رفع البلاغات (`/api/error-reports`) لغياب القيود (متوسط).

---

## 1) تجاوز كامل للمصادقة والتفويض (Critical)

### الأدلة

- تم تعطيل منظومة المصادقة الفعلية واستبدالها بدوال Mock في الخادم.
- الدالة `isAuthenticated` تقوم بحقن مستخدم وهمي دائمًا وتسمح بالمرور.
- الدالة `isAdmin` تتجاوز فحص صلاحيات المدير بالكامل (`next()` مباشرة).

### الأثر

أي طرف خارجي يستطيع تنفيذ عمليات إدارية حساسة بدون تسجيل دخول حقيقي، مثل:

- تعديل/حذف محتوى المواد:
  - `PATCH /api/articles/:lawId/:articleNumber/override`
  - `DELETE /api/articles/:lawId/:articleNumber/override`
- إدارة بلاغات الأخطاء:
  - `GET /api/error-reports`
  - `PATCH /api/error-reports/:id/resolve`
  - `DELETE /api/error-reports/:id`

### توصيات الإصلاح

- إعادة تفعيل المصادقة الفعلية (`setupAuth`, `registerAuthRoutes`) فورًا.
- إزالة أي Mock auth من بيئة الإنتاج.
- جعل `isAdmin` يتحقق فعليًا من `ADMIN_USER_IDS` أو من Role داخل Claims/JWT.
- إضافة اختبار تكاملي يضمن أن المسارات الإدارية ترجع `401/403` عند غياب الجلسة.

---

## 2) XSS محتمل في عرض النصوص القانونية (High)

### الأدلة

- يتم عرض نصوص باستخدام `dangerouslySetInnerHTML` عدة مرات في صفحة القانون.
- الدالة `normalizeArabicDate` تبني HTML (`<span ...>...</span>`) وتعيده مباشرة دون تعقيم شامل لباقي النص.

### الأثر

إذا وصلت بيانات تحتوي HTML/JS خبيث من مصدر بيانات خارجي أو من أي قناة إدخال، يمكن تنفيذ JavaScript داخل المتصفح (سرقة جلسة/Token، تعديل DOM، إلخ).

### توصيات الإصلاح

- قبل العرض، مرر أي HTML عبر sanitizer قوي (مثل DOMPurify) مع سياسة allowlist صارمة.
- يفضل استبدال `dangerouslySetInnerHTML` حيث أمكن بعرض نصي آمن + عناصر JSX محكومة.
- تطبيق CSP صارم (منع inline script قدر الإمكان).

---

## 3) قابلية DoS بسبب `limit` غير مقيّد في `/api/judgments` (Medium)

### الأدلة

- قيمة `limit` في `/api/judgments` تُقرأ مباشرة من Query بدون `Math.min`.
- في المقابل، `/api/gazette` يضع حدًا أقصى (`100`)؛ ما يعني أن نمط الحماية موجود لكنه غير مطبق هنا.

### الأثر

مهاجم يستطيع طلب `limit` كبير جدًا (مثل 100000) لإجبار الخادم/قاعدة البيانات على استهلاك موارد عالية وزيادة زمن الاستجابة.

### توصيات الإصلاح

- تقييد `limit` مثلًا إلى `100` مع التحقق من الحد الأدنى `>=1`.
- إضافة Rate limiting على مستوى المسار.
- تسجيل وتنبيه للطلبات غير الطبيعية (huge page/limit).

---

## 4) إساءة استخدام نقطة البلاغات `/api/error-reports` (Medium)

### الأدلة

- نقطة `POST /api/error-reports` مفتوحة دون مصادقة.
- التحقق مقتصر على وجود الحقول فقط، بدون:
  - تحديد طول آمن للحقول.
  - Rate limit.
  - CAPTCHA/anti-bot.

### الأثر

إمكانية إرسال Spam أو ضخ بيانات كبيرة تسبب تضخم قاعدة البيانات أو ضوضاء تشغيلية.

### توصيات الإصلاح

- إضافة Rate limit + Bot protection (CAPTCHA أو equivalent).
- فرض قيود طول (مثل `description <= 2000`).
- إضافة تنظيف/تطبيع للمدخلات.

---

## خطوات سريعة مقترحة (48 ساعة)

1. إزالة Mock auth وتفعيل حراسة حقيقية لمسارات الإدارة.
2. إضافة تعقيم HTML قبل أي `dangerouslySetInnerHTML`.
3. تقييد `limit` في `/api/judgments` وتمكين rate limiting.
4. تقوية endpoint البلاغات بضوابط مكافحة الإساءة.

## ملاحظات المراجعة

- هذه مراجعة كود فقط (بدون اختبار اختراق حي/ديناميكي).
- يوصى بمرحلة لاحقة تشمل DAST وفحص التبعيات (SCA) ضمن CI/CD.
